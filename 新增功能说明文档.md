# 训练数据导出与 AI 联动功能文档

本文档面向教师与开发者，系统梳理本次新增的两项功能：**训练过程数据导出**与**AI 助手与画布/教学内容联动**。内容包含功能概述、文件改动、技术实现细节与使用说明，方便运维、教学推广及后续扩展。

---

## 一、工作概述

1. **训练过程数据导出**
   - 支持一键导出训练历史（JSON / CSV）与训练图表（损失曲线、准确率曲线、混淆矩阵）。
   - 图表导出会将 tfvis 生成的多层画布/SVG 合并，保证 PNG 中曲线完整可见。

2. **AI 助手与画布联动**
   - 画布中的每个层在选中时会显示 AI 圆点，点击即可将层参数作为“附件”带入 AI 对话框。
   - 教学内容模块支持框选任意段落/公式，出现悬浮 AI 圆点并可附加为上下文，提供“解释说明 / 概括内容 / 出题测验”三种快捷操作。

---

## 二、涉及文件变更

### 2.1 新建文件

无新建源文件；新增文档为本文件 `README_新增功能.md`。

### 2.2 修改的主要文件

1. `index.html`
   - “导出代码”面板新增“导出训练数据”二级菜单（JSON / CSV）与“导出训练图表”按钮。
   - AI 助手对话框增加附件区，展示附加的层信息或教学内容，并提供快捷操作按钮。

2. `src/ui/style.scss`
   - 新增下拉菜单、AI 附件卡片、AI 圆点（画布/教学）等样式，保证交互反馈一致。

3. `src/ui/app.ts`
   - 新增训练历史导出（JSON/CSV）、图表导出（合并画布/SVG）核心逻辑。
   - 维护统一的 AI 附件状态 `pendingAiAttachment`，支持层与教学内容两种上下文。
   - 监听教学区文本选中，显示悬浮 AI 圆点并附加内容；实现解释/概括/测验快速提问。
   - 将 AI 发送逻辑集中在 `sendAiMessage()`，确保任意入口（手动输入或快捷操作）都能复用。

4. `src/ui/shapes/layer.ts`
   - 每个层在选中时会新增 `.ai-handle` 圆点；点击后调用 `sendLayerContextToAi()`。
   - 处理事件冒泡，保证点击圆点不会触发连接逻辑。

5. `src/ui/ai_assistant.ts`
   - `fetchAiResponse()` 新增 `educationContext` 参数，随请求发送到后端。

6. `src/model/GLM.py`
   - Flask 接口根据 `selectedLayer`、`taskName` 与 `educationContext` 构建完整提示词，调用 ZhipuAI。

---

## 三、技术实现细节

### 3.1 训练历史导出

1. **数据采集**  
   - `src/model/mnist_model.ts`（原有逻辑）在训练过程中记录 batch、epoch、test 指标与超参、时间戳。
   - 前端通过 `getTrainingHistory()` 获取完整结构。

2. **JSON / CSV 导出**  
   - `exportTrainingHistory(format)` 根据参数转换为 JSON（结构化）或 CSV（含元信息注释）。
   - CSV 顶部写入 `#dataset`、`#epochs` 等行，便于二次分析。

3. **图表导出**  
   - `exportTrainingCharts()` 遍历损失/准确率/混淆矩阵容器，调用 `renderChartContainerToImage()`。
   - `renderChartContainerToImage()`：  
     - 计算容器矩形位置，按 DPI 创建临时画布。  
     - 依次绘制容器内所有 canvas，并将 SVG 序列化成图片再绘制。  
     - 生成 PNG DataURL 下载，解决多画布导致只导出坐标轴的问题。

### 3.2 AI 与画布联动

1. **层圆点**  
   - `Layer` 构造时在 SVG 上追加 `.ai-handle`，仅在选中状态显示。
   - 点击圆点会将 layerType + params 存入 `pendingAiAttachment`，并展示在 AI 对话框附件区。

2. **教学内容选中**  
   - `setupEducationSelectionWatcher()` 监听 `selectionchange`，仅在 `#educationTab` 内才响应。
   - 若选中非空文本，显示悬浮 `.education-ai-handle`；点击后附加内容，并清空当前选区。
   - 附件区显示截断后的文本，按钮区提供“解释说明 / 概括内容 / 出题测验”。  
     - 这些按钮调用 `handleAiContextAction()` 自动生成 prompt，例如“请概括以下内容…”等。

3. **统一消息发送**  
   - `sendAiMessage()` 统一处理 AI 请求：从 `pendingAiAttachment` 自动注入层或教学内容信息。
   - `fetchAiResponse()` 将 `selectedLayer`、`taskName`、`educationContext` 一并发送给 Flask 后端。
   - 后端根据不同上下文拼接提示语，确保回答贴合当前操作背景。

### 3.3 使用流程

#### 训练数据导出
1. 在“训练进度”标签运行一次训练。
2. 右侧“导出代码”面板中：
   - 选择“导出 JSON / CSV”获取历史数据；
   - 点击“导出训练图表”取得曲线 + 混淆矩阵 PNG。

#### 画布层 AI 圆点
1. 在画布选中任意层 → 出现紫色 AI 圆点。
2. 点击圆点 → 对话框附件显示“已附加：Conv2D（filters:32, …）”。
3. 输入问题或直接发送，AI 会结合层参数回答；发送后附件自动清空。

#### 教学内容 AI 圆点
1. 切换到“教学”标签，框选任意段落或公式。
2. 右侧出现悬浮 AI 圆点，点击后内容附加到对话框。
3. 可直接输入问题，也可点击“解释 / 概括 / 测验”按钮，AI 会生成相应回答。
4. 点击附件右上角 “×” 可移除当前附件。

---

## 四、关键问题与解决方案

1. **tfvis 图表多画布导出**  
   - 问题：tfvis 的折线图使用多层 canvas/SVG 实现，直接 `toDataURL()` 只有坐标轴。  
   - 解决：遍历容器内所有绘图元素，按位置合成到一张临时画布后导出。

2. **事件冲突**  
   - 画布层的 AI 圆点需要阻止与连接线的点击冲突。通过 `stopPropagation()` 与命名空间事件确保 AI 圆点在不影响层操作的前提下生效。

3. **教学区选中范围限定**  
   - 仅当选中内容位于 `#educationTab` 内时才显示 AI 圆点，避免对其它区域产生干扰。

---

## 五、总结

- **训练数据导出** 让教师/学生可以一键保存训练历史与图表，方便离线分析或作业提交。
- **AI 助手联动** 将层参数与教学内容快速转化为可提问的上下文，提高教学互动效率。  
- 新增的 UI 与后端接口都保持模块化设计，后续若需扩展到优化器、损失函数或其他模块，只需复用同样的附件机制即可。

